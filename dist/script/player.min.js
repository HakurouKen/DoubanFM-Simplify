var Player=function(a,b,c,d){var e=function(a){function b(a){function b(a,b,c){var d="string"==typeof a?k.find(a):a;"text"===b?d.text(c):"html"===b?d.html(c):k.find(a).attr(b,c)}a&&(album=/\/subject\//.test(a.album)?"http://music.douban.com"+a.album:a.album,b("div.cover>img","src",a.picture.replace(/\/mpic\//,"/lpic/")),b(".cover","data-album","http://music.douban.com"+a.album),b(".infos .artist","text",a.artist),b(".infos .album-title","text","<"+a.albumtitle+">"),b(".infos .year","text",a.public_time),b(".infos .title-roller a","text",a.title),b(".infos .title-roller a","href","http://music.douban.com"+a.album),c("title").text(a.title+" - 豆瓣FM"))}var e,f,g,h,i,j,k=a?"string"==typeof a?c(a):a:c("body"),l=k.find(".player"),m=[],n=-1,o=[],p=0,q={},r=new Audio;r.autoplay=!0;var s={isAd:function(a){return!/^\/subject\//.test(a.album)},initSong:function(a){var c=this;return this.isAd(a)?c.initSong.caller.apply(this):(q=a,m.push(a),n++,r.src=a.url,b(a),chrome.extension.sendMessage({action:"notification",info:a},function(){})),this},getState:function(){return e},getSongInfo:function(){return q},getCurTime:function(){return r.currentTime},getSongList:function(){return m},getNextSongList:function(a,b){var d=this;c.ajax({url:"/j/mine/playlist",method:"GET",data:{type:a?a:"n",sid:q.sid,pt:Math.round(10*r.currentTime)/10,channel:c(".channel_list .channel.selected").data("cid")||0,pb:64,from:"mainsite",r:Math.round(0xffffffffff*Math.random()).toString(16)},success:function(c){"e"!==a&&(p=0,o=c.song),b&&b(c)},error:function(){setTimeout(function(){d.getNextSongList(a)},1e4)}})},play:function(){return r.currentTime=0,r.play(),this},pause:function(){return r.pause(),this},resume:function(){return r.play(),this},prev:function(){return n=--n>=0?n:0,this.initSong(m[n]),this},heart:function(a){return this.getNextSongList(a?"r":"u"),this},end:function(){var a=this;return a.getNextSongList("e"),o[++p]!==d?a.initSong(o[p]):this.getNextSongList("p",function(b){a.initSong(b.song[0])}),this},trash:function(){var a=this;return this.getNextSongList("b",function(b){a.initSong(b.song[0])}),this},next:function(){var a=this;return this.getNextSongList("s",function(b){a.initSong(b.song[0])}),this},vol:function(a){return a!==d?(a=parseInt(a),a=a>100?100:0>a?0:a,r.volume=a/100,this):i},volUp:function(a){return this.vol(i+a),this},volDown:function(a){return this.vol(i-a),this},mute:function(){return this.vol(0),this},jumpTo:function(a){var b,c=[],d=0;return"number"==typeof a?d=a:"string"==typeof a&&("%"===a.substr(-1)?d=parseInt(a.slice(0,-1))*r.duration/100:(c=a.split(":"),b=c.length,c.forEach(function(a,c){d+=parseInt(a)*Math.pow(60,b-1-c)}))),"number"==typeof d&&(r.currentTime=parseInt(d)),this},loop:function(a){return a===d?j:(j=!!a,this)},bind:function(a,b){r.addEventListener(a,b)},once:function(a,b){r.addEventListener(a,function(c){b(c),this.removeEventListener(a,arguments.callee)})}};return r.addEventListener("loadstart",function(){e=r.paused?"paused":"playing",f=r.duration,h=r.currentTime/r.duration,i=100*r.volume,j=r.loop}),r.addEventListener("play",function(){e="playing"}),r.addEventListener("pause",function(){e="pause"}),r.addEventListener("durationchange",function(){f=r.duration}),r.addEventListener("progress",function(){var a=r.buffered.length?r.buffered.length-1:0;setTimeout(function(){g=r.buffered.end(a)/f},1e3)}),r.addEventListener("timeupdate",function(){h=r.currentTime/f}),r.addEventListener("volumechange",function(){i=100*r.volume}),r.addEventListener("ended",function(){j?s.play():s.end()}),r.addEventListener("error",function(){s.end()}),r.addEventListener("progress",function(){r.buffered.length?r.buffered.length-1:0;k.find(".load-progress").width(l.width()*g)}),r.addEventListener("timeupdate",function(){var a=f-r.currentTime,b="-"+Math.floor(a/60)+":"+("0"+parseInt(a%60)).substr(-2);k.find(".controller .time").text(b),k.find(".play-progress").width(l.width()*h)}),s};return e}(window,document,jQuery);