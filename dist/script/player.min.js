var Player=function(a,b,c,d){var e=function(a){function b(a){function b(a,b,c){var d="string"==typeof a?j.find(a):a;"text"===b?d.text(c):"html"===b?d.html(c):j.find(a).attr(b,c)}a&&(album=/\/subject\//.test(a.album)?"http://music.douban.com"+a.album:a.album,b("div.cover>img","src",a.picture.replace(/\/mpic\//,"/lpic/")),b(".cover","data-album","http://music.douban.com"+a.album),b(".infos .artist","text",a.artist),b(".infos .album-title","text","<"+a.albumtitle+">"),b(".infos .year","text",a.public_time),b(".infos .title-roller a","text",a.title),b(".infos .title-roller a","href","http://music.douban.com"+a.album),b(".download","text",a.title),b(".download","title","下载 : "+a.title+" - "+a.artist),b(".download","href",a.url),c("title").text(a.title+" - 豆瓣FM"))}var e,f,g,h,i,j=a?"string"==typeof a?c(a):a:c("body"),k=j.find(".player"),l=[],m=-1,n=[],o=0,p={},q=new Audio,r=!1;q.autoplay=!0;var s={isAd:function(a){return!/^\/subject\//.test(a.album)},initSong:function(a){var c=this;return this.isAd(a)?c.initSong.caller.apply(this):(p=a,l.push(a),m++,q.src=a.url,b(a),chrome.extension.sendMessage({action:"notification",info:a},function(){})),this},getState:function(){return e},getSongInfo:function(){return p},getCurTime:function(){return q.currentTime},getSongList:function(){return l},getNextSongList:function(a,b){var d=this;c.ajax({url:"/j/mine/playlist",method:"GET",data:{type:a?a:"n",sid:p.sid,pt:Math.round(10*q.currentTime)/10,channel:c(".channel_list .channel.selected").data("cid")||0,pb:64,from:"mainsite",r:Math.round(0xffffffffff*Math.random()).toString(16)},success:function(c){"e"!==a&&(o=0,n=c.song),b&&b(c)},error:function(){setTimeout(function(){d.getNextSongList(a)},1e4)}})},play:function(){return q.currentTime=0,q.play(),this},pause:function(){return q.pause(),this},resume:function(){return q.play(),this},prev:function(){return m=--m>=0?m:0,this.initSong(l[m]),this},heart:function(a){return this.getNextSongList(a?"r":"u"),this},end:function(){var a=this;return a.getNextSongList("e"),n[++o]!==d?a.initSong(n[o]):this.getNextSongList("p",function(b){a.initSong(b.song[0])}),this},trash:function(){var a=this;return this.getNextSongList("b",function(b){a.initSong(b.song[0])}),this},next:function(){var a=this;return this.getNextSongList("s",function(b){a.initSong(b.song[0])}),this},vol:function(a){return a!==d?(a=parseInt(a),a=a>100?100:0>a?0:a,q.volume=a/100,this):i},volUp:function(a){return this.vol(i+a),this},volDown:function(a){return this.vol(i-a),this},mute:function(){return this.vol(0),this},jumpTo:function(a){var b,c=[],d=0;return"number"==typeof a?d=a:"string"==typeof a&&("%"===a.substr(-1)?d=parseInt(a.slice(0,-1))*q.duration/100:(c=a.split(":"),b=c.length,c.forEach(function(a,c){d+=parseInt(a)*Math.pow(60,b-1-c)}))),"number"==typeof d&&(q.currentTime=parseInt(d)),this},loop:function(a){return a===d?r:(r=q.loop=!!a,this)},bind:function(a,b){q.addEventListener(a,b)},once:function(a,b){q.addEventListener(a,function(c){b(c),this.removeEventListener(a,arguments.callee)})}};return q.addEventListener("loadstart",function(){e=q.paused?"paused":"playing",f=q.duration,h=q.currentTime/q.duration,i=100*q.volume,q.loop=r}),q.addEventListener("play",function(){e="playing"}),q.addEventListener("pause",function(){e="pause"}),q.addEventListener("durationchange",function(){f=q.duration}),q.addEventListener("timeupdate",function(){var a=q.buffered.length?q.buffered.length-1:0;g=q.buffered.end(a)/f}),q.addEventListener("timeupdate",function(){h=q.currentTime/f}),q.addEventListener("volumechange",function(){i=100*q.volume}),q.addEventListener("ended",function(){r?s.play():s.end()}),q.addEventListener("error",function(){s.end()}),q.addEventListener("progress",function(){q.buffered.length?q.buffered.length-1:0;j.find(".load-progress").width(k.width()*g)}),q.addEventListener("timeupdate",function(){var a=f-q.currentTime,b="-"+Math.floor(a/60)+":"+("0"+parseInt(a%60)).substr(-2);j.find(".controller .time").text(b),j.find(".play-progress").width(k.width()*h)}),s};return e}(window,document,jQuery);